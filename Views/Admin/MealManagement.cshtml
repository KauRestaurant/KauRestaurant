@model List<KauRestaurant.Models.Meal>
@using KauRestaurant.Services

@{
    ViewData["Title"] = "إدارة الوجبات";
}

<div>
    <!-- Main Content Section -->
    <div class="container-fluid py-4 py-lg-5 bg-white">
        <div class="container">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <!-- Card Header -->
            <div class="card border-0 shadow mb-4">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="fw-bold mb-0">إدارة الوجبات</h3>
                        <div>
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMealModal">
                                <i class="bi bi-plus-lg me-2"></i>إضافة وجبة جديدة
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Meal Filters -->
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="categoryFilter" class="form-label">فئة الوجبة</label>
                            <select id="categoryFilter" class="form-select">
                                <option value="">جميع الفئات</option>
                                <option value="الإفطار">الإفطار</option>
                                <option value="الغداء">الغداء</option>
                                <option value="العشاء">العشاء</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="typeFilter" class="form-label">نوع الوجبة</label>
                            <select id="typeFilter" class="form-select">
                                <option value="">جميع الأنواع</option>
                                <option value="الطبق الرئيسي">الطبق الرئيسي</option>
                                <option value="طبق جانبي">طبق جانبي</option>
                                <option value="حلوى">حلوى</option>
                                <option value="مشروب">مشروب</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="searchFilter" class="form-label">بحث</label>
                            <input type="text" id="searchFilter" class="form-control" placeholder="ابحث عن اسم الوجبة...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Meals List -->
            <div class="row" id="mealsList">
                @if (Model != null && Model.Any())
                {
                    foreach (var meal in Model)
                    {
                        <div class="col-md-6 col-lg-4 mb-4 meal-item"
                             data-category="@meal.MealCategory"
                             data-type="@meal.MealType"
                             data-name="@meal.MealName.ToLower()">
                            <div class="card border-0 shadow h-100">
                                <div class="position-relative">
                                    <img src="@(string.IsNullOrEmpty(meal.PicturePath) ? "/images/meal-placeholder.png" : meal.PicturePath)"
                                         class="card-img-top" alt="@meal.MealName" style="height:180px; object-fit:cover;">
                                    <div class="position-absolute top-0 start-0 p-2">
                                        @{
                                            var (icon, bgColor) = UIConstants.MealCategoryInfo.ContainsKey(meal.MealCategory)
                                            ? UIConstants.MealCategoryInfo[meal.MealCategory]
                                            : ("bi-question", "#6c757d");
                                        }
                                        <span class="badge" style="background-color: @bgColor">
                                            <i class="bi @icon me-1"></i>@meal.MealCategory
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title fw-bold">@meal.MealName</h5>
                                        <span class="badge @(UIConstants.MealTypeBadgeColors.ContainsKey(meal.MealType) ?
                                               UIConstants.MealTypeBadgeColors[meal.MealType] : "bg-secondary")">
                                            @meal.MealType
                                        </span>
                                    </div>
                                    <p class="card-text small text-muted mb-2" style="max-height:60px; overflow:hidden;">
                                        @meal.Description
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge bg-light text-dark">@meal.Calories سعرة حرارية</span>
                                    </div>
                                    <div class="row g-1 small text-muted mb-3">
                                        <div class="col-4 text-center">
                                            <div>بروتين</div>
                                            <strong>@meal.Protein جرام</strong>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div>كربوهيدرات</div>
                                            <strong>@meal.Carbs جرام</strong>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div>دهون</div>
                                            <strong>@meal.Fat جرام</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-white border-0 pt-0">
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-success flex-fill btn-edit-meal"
                                                data-meal-id="@meal.MealID"
                                                data-meal-name="@meal.MealName"
                                                data-meal-description="@meal.Description"
                                                data-meal-calories="@meal.Calories"
                                                data-meal-protein="@meal.Protein"
                                                data-meal-carbs="@meal.Carbs"
                                                data-meal-fat="@meal.Fat"
                                                data-meal-category="@meal.MealCategory"
                                                data-meal-type="@meal.MealType"
                                                data-meal-picture="@meal.PicturePath"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editMealModal">
                                            <i class="bi bi-pencil-square me-1"></i>تعديل
                                        </button>
                                        <button type="button" class="btn btn-outline-danger flex-fill btn-delete-meal"
                                                data-meal-id="@meal.MealID"
                                                data-meal-name="@meal.MealName"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteMealModal">
                                            <i class="bi bi-trash me-1"></i>حذف
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12">
                        <div class="alert alert-info">
                            لا توجد وجبات مسجلة حالياً. أضف وجبات جديدة باستخدام زر "إضافة وجبة جديدة".
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Add Meal Modal -->
<div class="modal fade" id="addMealModal" tabindex="-1" aria-labelledby="addMealModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-controller="MealManagement" asp-action="CreateMeal" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMealModalLabel">إضافة وجبة جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="mealName" class="form-label">اسم الوجبة</label>
                            <input type="text" class="form-control" id="mealName" name="MealName" required maxlength="100">
                        </div>
                        <div class="col-md-6">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label for="mealCategory" class="form-label">فئة الوجبة</label>
                                    <select class="form-select" id="mealCategory" name="MealCategory" required>
                                        <option value="الإفطار">الإفطار</option>
                                        <option value="الغداء">الغداء</option>
                                        <option value="العشاء">العشاء</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label for="mealType" class="form-label">نوع الوجبة</label>
                                    <select class="form-select" id="mealType" name="MealType" required>
                                        <option value="الطبق الرئيسي">الطبق الرئيسي</option>
                                        <option value="طبق جانبي">طبق جانبي</option>
                                        <option value="حلوى">حلوى</option>
                                        <option value="مشروب">مشروب</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="mealDescription" class="form-label">وصف الوجبة</label>
                            <textarea class="form-control" id="mealDescription" name="Description" rows="3" maxlength="500"></textarea>
                        </div>
                        <div class="col-12">
                            <label for="mealPicture" class="form-label">صورة الوجبة</label>
                            <input type="file" class="form-control" id="mealPicture" name="Picture" accept="image/*">
                        </div>
                        <div class="col-md-3">
                            <label for="mealCalories" class="form-label">السعرات الحرارية</label>
                            <input type="number" class="form-control" id="mealCalories" name="Calories" min="0" max="2000" required>
                        </div>
                        <div class="col-md-3">
                            <label for="mealProtein" class="form-label">البروتين (جرام)</label>
                            <input type="number" class="form-control" id="mealProtein" name="Protein" min="0" max="200" required>
                        </div>
                        <div class="col-md-3">
                            <label for="mealCarbs" class="form-label">الكربوهيدرات (جرام)</label>
                            <input type="number" class="form-control" id="mealCarbs" name="Carbs" min="0" max="200" required>
                        </div>
                        <div class="col-md-3">
                            <label for="mealFat" class="form-label">الدهون (جرام)</label>
                            <input type="number" class="form-control" id="mealFat" name="Fat" min="0" max="200" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success">إضافة الوجبة</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Meal Modal -->
<div class="modal fade" id="editMealModal" tabindex="-1" aria-labelledby="editMealModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-controller="MealManagement" asp-action="UpdateMeal" enctype="multipart/form-data">
                <input type="hidden" id="editMealId" name="MealID" value="">
                <div class="modal-header">
                    <h5 class="modal-title" id="editMealModalLabel">تعديل الوجبة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="editMealName" class="form-label">اسم الوجبة</label>
                            <input type="text" class="form-control" id="editMealName" name="MealName" required maxlength="100">
                        </div>
                        <div class="col-md-6">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label for="editMealCategory" class="form-label">فئة الوجبة</label>
                                    <select class="form-select" id="editMealCategory" name="MealCategory" required>
                                        <option value="الإفطار">الإفطار</option>
                                        <option value="الغداء">الغداء</option>
                                        <option value="العشاء">العشاء</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label for="editMealType" class="form-label">نوع الوجبة</label>
                                    <select class="form-select" id="editMealType" name="MealType" required>
                                        <option value="الطبق الرئيسي">الطبق الرئيسي</option>
                                        <option value="طبق جانبي">طبق جانبي</option>
                                        <option value="حلوى">حلوى</option>
                                        <option value="مشروب">مشروب</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="editMealDescription" class="form-label">وصف الوجبة</label>
                            <textarea class="form-control" id="editMealDescription" name="Description" rows="3" maxlength="500"></textarea>
                        </div>
                        <div class="col-12">
                            <div class="mb-2">
                                <img id="currentMealImage" src="" alt="صورة الوجبة الحالية" class="img-thumbnail" style="max-height: 150px; display: none;">
                            </div>
                            <label for="editMealPicture" class="form-label">تغيير صورة الوجبة (اترك فارغاً للاحتفاظ بالصورة الحالية)</label>
                            <input type="file" class="form-control" id="editMealPicture" name="Picture" accept="image/*">
                            <input type="hidden" id="currentPicturePath" name="CurrentPicturePath" value="">
                        </div>
                        <div class="col-md-3">
                            <label for="editMealCalories" class="form-label">السعرات الحرارية</label>
                            <input type="number" class="form-control" id="editMealCalories" name="Calories" min="0" max="2000" required>
                        </div>
                        <div class="col-md-3">
                            <label for="editMealProtein" class="form-label">البروتين (جرام)</label>
                            <input type="number" class="form-control" id="editMealProtein" name="Protein" min="0" max="200" required>
                        </div>
                        <div class="col-md-3">
                            <label for="editMealCarbs" class="form-label">الكربوهيدرات (جرام)</label>
                            <input type="number" class="form-control" id="editMealCarbs" name="Carbs" min="0" max="200" required>
                        </div>
                        <div class="col-md-3">
                            <label for="editMealFat" class="form-label">الدهون (جرام)</label>
                            <input type="number" class="form-control" id="editMealFat" name="Fat" min="0" max="200" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success">حفظ التغييرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Meal Modal -->
<div class="modal fade" id="deleteMealModal" tabindex="-1" aria-labelledby="deleteMealModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-controller="MealManagement" asp-action="DeleteMeal">
                <input type="hidden" id="deleteMealId" name="MealID" value="">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteMealModalLabel">تأكيد الحذف</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>هل أنت متأكد من رغبتك في حذف هذه الوجبة؟</p>
                    <p class="fw-bold" id="deleteMealName"></p>
                    <p class="text-danger">لا يمكن التراجع عن هذا الإجراء.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-danger">نعم، قم بالحذف</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Meal filtering functionality
            $("#categoryFilter, #typeFilter, #searchFilter").on("change keyup", function() {
                var categoryFilter = $("#categoryFilter").val().toLowerCase();
                var typeFilter = $("#typeFilter").val().toLowerCase();
                var searchFilter = $("#searchFilter").val().toLowerCase();

                $(".meal-item").each(function() {
                    var category = $(this).data("category").toLowerCase();
                    var type = $(this).data("type").toLowerCase();
                    var name = $(this).data("name").toLowerCase();

                    // Show/hide based on filters
                    var matchCategory = categoryFilter === "" || category === categoryFilter;
                    var matchType = typeFilter === "" || type === typeFilter;
                    var matchSearch = searchFilter === "" || name.includes(searchFilter);

                    if (matchCategory && matchType && matchSearch) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            // Edit meal button click
            $(".btn-edit-meal").click(function() {
                var mealId = $(this).data("meal-id");
                var mealName = $(this).data("meal-name");
                var mealDescription = $(this).data("meal-description");
                var mealCalories = $(this).data("meal-calories");
                var mealProtein = $(this).data("meal-protein");
                var mealCarbs = $(this).data("meal-carbs");
                var mealFat = $(this).data("meal-fat");
                var mealCategory = $(this).data("meal-category");
                var mealType = $(this).data("meal-type");
                var mealPicture = $(this).data("meal-picture");

                // Set values in the edit form
                $("#editMealId").val(mealId);
                $("#editMealName").val(mealName);
                $("#editMealDescription").val(mealDescription);
                $("#editMealCalories").val(mealCalories);
                $("#editMealProtein").val(mealProtein);
                $("#editMealCarbs").val(mealCarbs);
                $("#editMealFat").val(mealFat);
                $("#editMealCategory").val(mealCategory);
                $("#editMealType").val(mealType);
                $("#currentPicturePath").val(mealPicture);

                // Show the current meal image if available
                if (mealPicture && mealPicture !== "") {
                    $("#currentMealImage").attr("src", mealPicture).show();
                } else {
                    $("#currentMealImage").hide();
                }
            });

            // Delete meal button click
            $(".btn-delete-meal").click(function() {
                var mealId = $(this).data("meal-id");
                var mealName = $(this).data("meal-name");

                // Set the meal ID and name in the delete confirmation modal
                $("#deleteMealId").val(mealId);
                $("#deleteMealName").text(mealName);
            });
        });
    </script>
}
