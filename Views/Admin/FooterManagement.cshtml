@model KauRestaurant.ViewModels.FooterManagementViewModel
@{
    ViewData["Title"] = "إدارة تذييل الصفحة";
}

<div class="container-fluid py-4 py-lg-5 bg-white">
    <div class="container">
        <!-- Page Header Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header bg-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="fw-bold mb-0"><i class="bi bi-layout-text-window-reverse me-2"></i>إدارة تذييل الصفحة</h3>
                            <a asp-area="Admin" asp-controller="Dashboard" asp-action="Index" class="btn btn-outline-success">
                                <i class="bi bi-arrow-right me-1"></i>العودة للوحة التحكم
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                <i class="bi bi-check-circle me-2"></i> @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i> @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <!-- Management Tabs -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-body p-0">
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs border-0" id="footerTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active px-4 py-3" id="faq-tab" data-bs-toggle="tab"
                                        data-bs-target="#faq-content" type="button" role="tab">
                                    <i class="bi bi-question-circle me-2"></i>الأسئلة الشائعة
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link px-4 py-3" id="terms-tab" data-bs-toggle="tab"
                                        data-bs-target="#terms-content" type="button" role="tab">
                                    <i class="bi bi-shield-check me-2"></i>الشروط والأحكام
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="footerTabsContent">

                            <!-- FAQ Tab -->
                            <div class="tab-pane fade show active p-4" id="faq-content" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h4 class="mb-0">إدارة الأسئلة الشائعة</h4>
                                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addFaqModal">
                                        <i class="bi bi-plus-lg me-2"></i>إضافة سؤال جديد
                                    </button>
                                </div>

                                <!-- FAQ List -->
                                @if (Model.FAQs != null && Model.FAQs.Any())
                                {
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th scope="col" width="60">#</th>
                                                    <th scope="col">السؤال</th>
                                                    <th scope="col" width="150">الإجراءات</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var faq in Model.FAQs.OrderBy(f => f.DisplayOrder))
                                                {
                                                    <tr>
                                                        <td>@faq.DisplayOrder</td>
                                                        <td class="text-truncate">@faq.Question</td>
                                                        <td>
                                                            <div class="btn-group">
                                                                <button type="button" class="btn btn-sm btn-outline-success edit-faq-btn"
                                                                        data-id="@faq.FAQID"
                                                                        data-question="@faq.Question"
                                                                        data-answer="@faq.Answer"
                                                                        data-order="@faq.DisplayOrder"
                                                                        data-bs-toggle="modal" data-bs-target="#editFaqModal">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-danger delete-faq-btn"
                                                                        data-id="@faq.FAQID"
                                                                        data-question="@faq.Question.Substring(0, Math.Min(faq.Question.Length, 30))"
                                                                        data-bs-toggle="modal" data-bs-target="#deleteFaqModal">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i> لا توجد أسئلة شائعة مضافة حالياً.
                                    </div>
                                }
                            </div>

                            <!-- Terms Tab -->
                            <div class="tab-pane fade p-4" id="terms-content" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h4 class="mb-0">إدارة الشروط والأحكام</h4>
                                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTermsModal">
                                        <i class="bi bi-plus-lg me-2"></i>إضافة شروط جديدة
                                    </button>
                                </div>

                                <!-- Terms List -->
                                @if (Model.Terms != null && Model.Terms.Any())
                                {
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th scope="col" width="60">#</th>
                                                    <th scope="col">العنوان</th>
                                                    <th scope="col">تاريخ التحديث</th>
                                                    <th scope="col" width="150">الإجراءات</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var term in Model.Terms)
                                                {
                                                    <tr>
                                                        <td>@term.DisplayOrder</td>
                                                        <td>@(string.IsNullOrEmpty(term.Title) ? "الشروط والأحكام" : term.Title)</td>
                                                        <td>@term.LastUpdated.ToString("yyyy/MM/dd")</td>
                                                        <td>
                                                            <div class="btn-group">
                                                                <button type="button" class="btn btn-sm btn-outline-success edit-terms-btn"
                                                                        data-id="@term.TermID"
                                                                        data-title="@term.Title"
                                                                        data-order="@term.DisplayOrder"
                                                                        data-bs-toggle="modal" data-bs-target="#editTermsModal">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-danger delete-terms-btn"
                                                                        data-id="@term.TermID"
                                                                        data-title="@(string.IsNullOrEmpty(term.Title) ? "الشروط والأحكام" : term.Title)"
                                                                        data-bs-toggle="modal" data-bs-target="#deleteTermsModal">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Hidden content for edit operations -->
                                    <div class="d-none">
                                        @foreach (var term in Model.Terms)
                                        {
                                            <div id="term-content-@term.TermID">@Html.Raw(term.Content)</div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i> لا توجد شروط وأحكام مضافة حالياً.
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FAQ Modals -->
<!-- Add FAQ Modal -->
<div class="modal fade" id="addFaqModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form method="post" asp-action="AddFAQ">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة سؤال جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">السؤال</label>
                        <input type="text" class="form-control" name="Question" required maxlength="500">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الإجابة</label>
                        <textarea class="form-control" name="Answer" rows="6" required maxlength="2000"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ترتيب العرض</label>
                        <input type="number" class="form-control" name="DisplayOrder" value="1" min="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success">إضافة</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit FAQ Modal -->
<div class="modal fade" id="editFaqModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form method="post" asp-action="EditFAQ">
                <input type="hidden" id="edit-faq-id" name="FAQID">
                <div class="modal-header">
                    <h5 class="modal-title">تعديل سؤال</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">السؤال</label>
                        <input type="text" id="edit-faq-question" class="form-control" name="Question" required maxlength="500">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الإجابة</label>
                        <textarea id="edit-faq-answer" class="form-control" name="Answer" rows="6" required maxlength="2000"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ترتيب العرض</label>
                        <input type="number" id="edit-faq-order" class="form-control" name="DisplayOrder" min="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success">حفظ التغييرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete FAQ Modal -->
<div class="modal fade" id="deleteFaqModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" asp-action="DeleteFAQ">
                <input type="hidden" id="delete-faq-id" name="id">
                <div class="modal-header">
                    <h5 class="modal-title">حذف سؤال</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>هل أنت متأكد من رغبتك في حذف السؤال "<span id="delete-faq-question" class="fw-bold"></span>"؟</p>
                    <p class="text-danger">هذا الإجراء لا يمكن التراجع عنه.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-danger">حذف</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Terms Modals -->
<!-- Add Terms Modal -->
<div class="modal fade" id="addTermsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <form method="post" asp-action="AddTerms">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة شروط وأحكام جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">العنوان</label>
                            <input type="text" class="form-control" name="Title" maxlength="200">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">ترتيب العرض</label>
                            <input type="number" class="form-control" name="DisplayOrder" value="1" min="1" style="text-align: right; width: 100%;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">المحتوى</label>
                        <textarea class="form-control content-editor" id="terms-content-editor" name="Content" rows="15" required></textarea>
                        <small class="text-muted">يمكنك استخدام HTML لتنسيق المحتوى.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success">إضافة</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Terms Modal -->
<div class="modal fade" id="editTermsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <form method="post" asp-action="EditTerms">
                <input type="hidden" id="edit-terms-id" name="TermID">
                <div class="modal-header">
                    <h5 class="modal-title">تعديل الشروط والأحكام</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">العنوان</label>
                            <input type="text" id="edit-terms-title" class="form-control" name="Title" maxlength="200">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">ترتيب العرض</label>
                            <input type="number" id="edit-terms-order" class="form-control" name="DisplayOrder" min="1" style="text-align: right; width: 100%;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">المحتوى</label>
                        <textarea class="form-control content-editor" id="edit-terms-content" name="Content" rows="15" required></textarea>
                        <small class="text-muted">يمكنك استخدام HTML لتنسيق المحتوى.</small>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success">حفظ التغييرات</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Delete Terms Modal -->
<div class="modal fade" id="deleteTermsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" asp-action="DeleteTerms">
                <input type="hidden" id="delete-terms-id" name="id">
                <div class="modal-header">
                    <h5 class="modal-title">حذف شروط وأحكام</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>هل أنت متأكد من رغبتك في حذف "<span id="delete-terms-title" class="fw-bold"></span>"؟</p>
                    <p class="text-danger">هذا الإجراء لا يمكن التراجع عنه.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-danger">حذف</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Make sure first tab is active
            $('#faq-tab').tab('show');

            // Add simple formatting toolbar to textareas
            $('.content-editor').each(function() {
                var $textarea = $(this);
                var $toolbar = $('<div class="btn-toolbar mb-2" role="toolbar"></div>');

                var $btnGroup = $('<div class="btn-group me-2" role="group"></div>');

                // Add formatting buttons
                $btnGroup.append('<button type="button" class="btn btn-sm btn-outline-secondary" data-format="bold"><i class="bi bi-type-bold"></i></button>');
                $btnGroup.append('<button type="button" class="btn btn-sm btn-outline-secondary" data-format="italic"><i class="bi bi-type-italic"></i></button>');
                $btnGroup.append('<button type="button" class="btn btn-sm btn-outline-secondary" data-format="heading"><i class="bi bi-type-h1"></i></button>');

                var $btnGroup2 = $('<div class="btn-group me-2" role="group"></div>');
                $btnGroup2.append('<button type="button" class="btn btn-sm btn-outline-secondary" data-format="ul"><i class="bi bi-list-ul"></i></button>');
                $btnGroup2.append('<button type="button" class="btn btn-sm btn-outline-secondary" data-format="ol"><i class="bi bi-list-ol"></i></button>');
                $btnGroup2.append('<button type="button" class="btn btn-sm btn-outline-secondary" data-format="link"><i class="bi bi-link"></i></button>');

                $toolbar.append($btnGroup);
                $toolbar.append($btnGroup2);

                // Insert toolbar before textarea
                $textarea.before($toolbar);

                // Add click handlers
                $toolbar.find('button').click(function() {
                    var format = $(this).data('format');
                    var textarea = $textarea[0];
                    var start = textarea.selectionStart;
                    var end = textarea.selectionEnd;
                    var selectedText = textarea.value.substring(start, end);
                    var replacement = '';

                    switch(format) {
                        case 'bold':
                            replacement = '<strong>' + selectedText + '</strong>';
                            break;
                        case 'italic':
                            replacement = '<em>' + selectedText + '</em>';
                            break;
                        case 'heading':
                            replacement = '<h3>' + selectedText + '</h3>';
                            break;
                        case 'ul':
                            var items = selectedText.split('\n');
                            replacement = '<ul>\n';
                            items.forEach(function(item) {
                                if (item.trim()) {
                                    replacement += '  <li>' + item + '</li>\n';
                                }
                            });
                            replacement += '</ul>';
                            break;
                        case 'ol':
                            var items = selectedText.split('\n');
                            replacement = '<ol>\n';
                            items.forEach(function(item) {
                                if (item.trim()) {
                                    replacement += '  <li>' + item + '</li>\n';
                                }
                            });
                            replacement += '</ol>';
                            break;
                        case 'link':
                            var url = prompt('أدخل الرابط:', 'https://');
                            if (url) {
                                replacement = '<a href="' + url + '">' + (selectedText || url) + '</a>';
                            } else {
                                return;
                            }
                            break;
                    }

                    // Insert the formatted text
                    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);

                    // Set cursor position after the insertion
                    textarea.focus();
                    textarea.selectionStart = start + replacement.length;
                    textarea.selectionEnd = start + replacement.length;
                });
            });

            // FAQ Edit Button
            $('.edit-faq-btn').click(function() {
                $('#edit-faq-id').val($(this).data('id'));
                $('#edit-faq-question').val($(this).data('question'));
                $('#edit-faq-answer').val($(this).data('answer'));
                $('#edit-faq-order').val($(this).data('order'));
            });

            // FAQ Delete Button
            $('.delete-faq-btn').click(function() {
                $('#delete-faq-id').val($(this).data('id'));
                $('#delete-faq-question').text($(this).data('question'));
            });

            // Terms Edit Button
            $('.edit-terms-btn').click(function() {
                $('#edit-terms-id').val($(this).data('id'));
                $('#edit-terms-title').val($(this).data('title'));
                $('#edit-terms-order').val($(this).data('order'));
    
                // Get content from hidden div
                var content = $('#term-content-' + $(this).data('id')).html();
                $('#edit-terms-content').val(content);
            });



            // Terms Delete Button
            $('.delete-terms-btn').click(function() {
                $('#delete-terms-id').val($(this).data('id'));
                $('#delete-terms-title').text($(this).data('title'));
            });
        });
    </script>
}
